<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Admin | Portfolio CMS</title>
    <link rel="icon" href="/favicon.ico" />
  </head>
  <body>
  <!-- Decap CMS main bundle (manual init to avoid double-init issues) -->
    <script>window.CMS_MANUAL_INIT = true;</script>
    <!-- Capture OAuth hash ASAP before CMS/router may change it -->
    <script>
      (function () {
        try {
          if (location.hash && location.hash.startsWith('#authorization:github:')) {
            sessionStorage.setItem('decap-cms-oauth', location.hash.slice(1));
            // Normalize hash for decap router to avoid clobbering our message later
            if (location.hash !== '#/') {
              history.replaceState(null, '', location.pathname + (location.search || '') + '#/');
            }
          }
        } catch (_) {}
      })();
    </script>
    <!-- Pin to a known-stable version to avoid transient upstream regressions -->
    <script src="https://unpkg.com/decap-cms@3.7.1/dist/decap-cms.js"></script>
    <script>
      // Delay init until the page is fully loaded to avoid DOM detach race conditions
      window.addEventListener('load', function () {
        try {
          // If the OAuth function redirected back without a popup, it appends a hash like
          // #authorization:github:success:{"token":"..."}
          if (location.hash && location.hash.startsWith('#authorization:github:')) {
            // Stash it so we can resend after CMS attaches its message listener
            sessionStorage.setItem('decap-cms-oauth', location.hash.slice(1));
            // Clear the hash to avoid re-processing on reload
            history.replaceState(null, '', location.pathname);
          }
        } catch (_) {}

        if (window.CMS) window.CMS.init({ configPath: '/admin/config.yml' });

        // After init, re-post the stashed oauth message so CMS can consume it
        (function repostOAuthMessage(retries) {
          var msg = null;
          try { msg = sessionStorage.getItem('decap-cms-oauth'); } catch (_) {}
          if (msg) {
            try { window.postMessage(msg, '*'); } catch (_) {}
            try { sessionStorage.removeItem('decap-cms-oauth'); } catch (_) {}
            return; // done
          }
          if (retries > 0) {
            setTimeout(function(){ repostOAuthMessage(retries - 1); }, 150);
          }
        })(20); // retry for ~3 seconds
      });
    </script>
  </body>
</html>
